# 价格预警自动监控指南

## 功能概述

价格预警系统现在支持**自动后台监控**，可以持续运行，自动检查价格并触发预警通知，无需手动点击检查。

## 功能特性

✅ **自动启动**：系统启动时自动开始监控
✅ **后台运行**：监控在后台线程中运行，不影响其他操作
✅ **定期检查**：默认每 30 秒检查一次价格（使用yahooquery批量获取）
✅ **实时通知**：触发预警时立即发送桌面通知或邮件
✅ **状态显示**：侧边栏显示监控状态和激活预警数量
✅ **一键控制**：点击按钮即可启动/停止监控

## 使用方法

### 1. 查看监控状态

打开系统后，在左侧边栏的 **"📊 预警监控"** 区域查看：

```
📊 预警监控
🟢 监控运行中    [⏸️]
激活预警: 3 个
检查间隔: 30 秒
```

**状态说明**：
- 🟢 监控运行中：预警监控正在后台运行
- ⚪ 监控已停止：预警监控已停止

### 2. 启动/停止监控

**启动监控**：
- 点击 **▶️** 按钮启动监控
- 系统会立即开始后台检查

**停止监控**：
- 点击 **⏸️** 按钮停止监控
- 监控线程会安全停止

### 3. 自动启动设置

系统默认在启动时**自动开始监控**，无需手动点击。

如果想要关闭自动启动，可以设置环境变量：

**方法 1：创建或编辑 `.env` 文件**
```bash
# 在项目根目录创建 .env 文件
AUTO_START_MONITORING=False
```

**方法 2：修改 `config.py`**
```python
ALERT_MONITORING_CONFIG = {
    'auto_start': False,  # 改为 False 禁用自动启动
    'check_interval': 300,
}
```

### 4. 自定义检查间隔

默认每 **30 秒** 检查一次价格，可以自定义间隔：

**方法 1：环境变量（推荐）**
```bash
# 在 .env 文件中添加
ALERT_CHECK_INTERVAL=60  # 改为 1 分钟（单位：秒）
```

**方法 2：修改配置文件**
```python
# config.py
ALERT_MONITORING_CONFIG = {
    'auto_start': True,
    'check_interval': 60,  # 1 分钟
}
```

**推荐间隔设置**（使用yahooquery批量获取）：
- **30 秒**：**推荐设置** ⭐ 批量获取多个股票只算1次API调用
- **1 分钟（60秒）**：更保守的选择
- **5 分钟（300秒）**：减少网络请求
- **10 分钟（600秒）**：长期投资者

## 工作原理

### 监控流程

```
启动监控
    ↓
获取所有激活的预警
    ↓
提取需要监控的股票代码
    ↓
批量获取最新价格（yahooquery批量模式）
    ↓
逐个检查预警条件
    ↓
触发条件满足？
    ├─ 是 → 更新数据库状态为"已触发"
    │        发送通知（桌面/邮件）
    │        记录触发时间和价格
    ↓
等待检查间隔
    ↓
重复循环...
```

### 触发条件

预警会在以下情况触发：

1. **高于预警**：`当前价格 >= 目标价格`
2. **低于预警**：`当前价格 <= 目标价格`
3. **穿越预警**：`|当前价格 - 目标价格| / 目标价格 < 0.2%`

### 触发后行为

预警触发后：
- ✅ 状态变为"已触发"
- ✅ 记录触发时间和触发价格
- ✅ 发送通知
- ⚠️ **不会再次触发**（除非重新激活）

## 通知设置

### 桌面通知（默认）

**Windows**：
- 使用 Windows 10/11 通知中心
- 需要安装 `win10toast` 库（已包含在 requirements.txt）
- 通知会显示在右下角

**macOS**：
- 使用系统原生通知
- 无需额外依赖

**Linux**：
- 使用 `notify-send` 命令
- 需要系统已安装通知守护进程

### 邮件通知

如果选择邮件通知，需要先配置邮箱：

详见：[EMAIL_SETUP_GUIDE.md](EMAIL_SETUP_GUIDE.md)

## 监控管理

### 查看已触发的预警

在"价格预警"页面 → "历史预警"标签中查看所有已触发的预警。

每个触发记录包含：
- 触发时间
- 触发价格
- 预设操作
- 预设股数
- 备注

### 重新激活预警

已触发的预警可以在"历史预警"中重新激活：
1. 找到要重新激活的预警
2. 点击"重新激活"按钮
3. 预警状态变为"激活"，继续监控

### 编辑预警

在"激活预警"标签中：
1. 点击预警右侧的 ✏️ 编辑按钮
2. 修改目标价格、通知方式等
3. 点击"💾 保存"

### 删除预警

在"激活预警"或"历史预警"标签中：
1. 点击预警右侧的 🗑️ 删除按钮
2. 确认删除

## 故障排除

### 监控无法启动

**可能原因**：
- 网络连接问题
- yahooquery API 无法访问

**解决方法**：
1. 检查网络连接
2. 手动点击"手动检查预警"测试
3. 查看控制台错误信息

### 价格获取失败

**症状**：监控运行，但没有触发

**可能原因**：
1. Yahoo Finance API 429 错误（请求过多）
2. 股票代码错误
3. 网络问题

**解决方法**：
1. 增加检查间隔（例如改为 10 分钟）
2. 检查股票代码是否正确
3. 查看"手动检查预警"是否正常工作

### 桌面通知不显示

**Windows**：
1. 确认已安装 `win10toast`：`pip install win10toast`
2. 检查 Windows 通知设置是否开启
3. 尝试重启应用

**macOS/Linux**：
1. 检查系统通知权限
2. 确认通知守护进程运行正常

### 通知延迟

**正常现象**：
- 监控不是实时的，受检查间隔限制
- 默认 30 秒间隔，意味着最多 30 秒延迟
- ⚠️ 数据本身有15-20分钟延迟（Yahoo Finance免费API限制）

**解决方法**：
- 减少检查间隔（但注意 API 限制）
- 对于重要价格，可以手动检查

### 重启后监控停止

**原因**：
- 监控是运行在内存中的线程
- 关闭浏览器或重启系统后会停止

**解决方法**：
- 确保 `AUTO_START_MONITORING=True`（默认）
- 重新打开应用时会自动启动

## 最佳实践

### 1. 合理设置预警数量

- ✅ 建议：5-10 个激活预警
- ⚠️ 避免：50+ 个预警（影响性能）

### 2. 合理设置检查间隔

根据交易风格选择（yahooquery批量模式下可以更频繁）：
- **日内交易**：30-60 秒
- **波段交易**：1-5 分钟
- **长期投资**：5-10 分钟

### 3. 定期清理已触发预警

- 每周检查一次"历史预警"
- 删除不再需要的预警
- 重新激活需要继续监控的预警

### 4. 测试通知

在添加重要预警前：
1. 先添加一个测试预警（设置很容易触发的价格）
2. 等待触发，确认通知正常
3. 再添加真实预警

### 5. 备份预警设置

预警保存在数据库中，建议定期备份：
- 进入"数据管理"页面
- 点击"立即备份"
- 备份包含所有预警设置

## 高级配置

### 数据源说明

系统使用 **yahooquery** 批量获取价格：
- 多个股票一次API调用
- 自动盘后缓存优化
- ⚠️ 数据有15-20分钟延迟（免费API限制）

详见：[PRICE_SOURCES_GUIDE.md](PRICE_SOURCES_GUIDE.md)

### 自定义通知

可以修改 `decision/alert_system.py` 中的通知逻辑：

```python
def _send_desktop_notification(self, alert, current_price):
    """自定义桌面通知"""
    title = f"⚠️ {alert['stock_symbol']} 预警触发"
    message = f"目标: ${alert['target_price']}\n当前: ${current_price}"
    # 添加自定义逻辑...
```

### 集成外部通知服务

可以添加对以下服务的支持：
- Telegram Bot
- 微信企业号
- Slack
- Discord

## 监控性能

### 资源使用

- **CPU**：极低（后台线程）
- **内存**：< 50MB
- **网络**：取决于预警数量和检查间隔
  - 5 个预警，5 分钟间隔 ≈ 每小时 12 次请求

### API 限制

**yahooquery (Yahoo Finance)**：
- 无官方限制说明
- 批量获取：多个股票 = 1次API调用
- 建议间隔：30秒以上

**推荐**（批量模式）：
- 任意数量预警：30-60 秒间隔（批量获取不受股票数量影响）
- 保守设置：1-5 分钟间隔

## 总结

价格预警自动监控功能让你：

✅ **解放双手**：无需手动检查，系统自动监控
✅ **不错过机会**：价格到达目标价立即通知
✅ **灵活配置**：自定义检查间隔和通知方式
✅ **安全可靠**：后台线程运行，不影响其他功能

现在你可以：
1. ✅ 打开系统，监控自动启动
2. ✅ 添加需要的预警
3. ✅ 放心去做其他事情
4. ✅ 等待桌面通知提醒

**建议**：保持系统在后台运行，监控会持续工作！

---

**最后更新**：2026-01-02
**相关文档**：
- [EMAIL_SETUP_GUIDE.md](EMAIL_SETUP_GUIDE.md) - 邮件通知配置
- [PRICE_SOURCES_GUIDE.md](PRICE_SOURCES_GUIDE.md) - 价格数据源配置
