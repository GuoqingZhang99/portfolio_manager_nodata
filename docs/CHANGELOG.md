# 更新日志 (Changelog)

本文档记录投资组合管理系统的所有重要更新和改进。

---

## [v2.0] - 2026-01-02

### 🎉 重大功能更新

#### 交易管理 CRUD 完整支持

**新增功能**：
- ✅ **交易编辑**：支持修改已录入的股票和期权交易记录
- ✅ **交易删除**：带确认对话框的安全删除机制
- ✅ **完整 CRUD**：所有交易数据支持增删改查操作

**技术实现**：
- 新增数据库方法：`update_transaction()`, `update_option_trade()`, `delete_option_trade()`
- 使用 Streamlit Session State 管理编辑状态
- 使用 `@st.dialog` 实现模态确认对话框

**用户体验**：
- 编辑模式指示器，明确显示当前状态
- 表单自动填充原有数据
- 动态按钮文本（提交/更新自动切换）
- 所有删除操作需要二次确认

#### Dashboard 盈亏指标改进

**新增指标**：
- **账户总盈亏**：`当前总资产 - 初始资本 - 净现金流入`
- **总盈亏比%**：`总盈亏 / (初始资本 + 净现金流入) × 100%`

**改进逻辑**：
- 正确处理净现金流入（利息、存款、取款）
- 移除重复的"可用总资金"指标
- 实时价格计算当前总资产

**显示优化**：
- 盈亏金额带正负号和颜色
- 盈亏比显示为百分比

#### 期权持仓完整历史

**新增功能**：
- 📊 **持仓中期权**：显示所有未平仓合约
- 📜 **已平仓/到期期权历史**：完整生命周期记录
- 自动盈亏计算：权利金收入 - 平仓成本 - 手续费
- 状态分类：持仓中、已平仓、已到期、已行权

**显示优化**：
- 智能排序：持仓中在顶部，已结束在下方
- 详细信息展示：包含开仓和平仓的完整交易详情

#### 数据表格排序修复

**问题**：之前数据被格式化为字符串，排序结果不准确

**解决方案**：
- 使用 Streamlit `NumberColumn` 配置
- 保留原始数值，通过 `format` 参数控制显示
- 支持正确的数值升序/降序排序

**影响范围**：
- Dashboard 持仓明细表
- 仓位管理页面
- 所有数值列（价格、金额、百分比）

#### 技术栈升级

**Streamlit 升级**：
- 升级到最新版本（1.31.0）
- 修复废弃警告：`use_container_width` → `width='stretch'`
- 使用新特性：`@st.dialog` 模态对话框

**代码质量**：
- 批量替换废弃 API
- 优化数据库操作
- 改进错误处理

---

## [v1.5] - 2025-12-29

### UI 界面优化

#### 资产配置图表细分

**改进前**：所有股票汇总为一个"股票投资"类别

**改进后**：
- 每只股票单独显示，各有独特颜色
- 10 种颜色循环使用
- 特殊类别配色：期权锁定（黄色）、可用现金（浅绿色）

**效果**：清晰看到各股票在总资产中的占比

#### 表格列宽优化

**改进前**：使用 `use_container_width=True`，列宽平均分配，浪费空间

**改进后**：
- 每列使用精确像素宽度
- 股票代码：60px
- 股数：55px
- 价格：70px
- 金额：90px

**效果**：提高信息密度，减少滚动

#### 仓位管理显示分离

**改进前**：已持仓股票和待开仓股票混在一起

**改进后**：
- 📊 **已持仓股票**：显示加仓、减仓、持有的股票
- 🚀 **待开仓股票**：显示已设置目标但尚未持仓的股票
- 两表格之间有明显分隔线

**效果**：清晰区分现有仓位和计划开仓

### 价格和盈亏显示增强

#### Dashboard 新增显示

**新增列**：
- 当前价格
- 盈亏金额
- 盈亏%
- 当前市值

**显示顺序**：
```
股票 | 股数 | 成本 | 现价 | 盈亏$ | 盈亏% | 投入$ | 市值$ | 可用 | 锁定
```

#### 仓位管理增强

**有目标时**：显示目标金额、偏离、再平衡建议

**无目标时**：简化视图，显示基本持仓信息

**价格获取**：
- 批量获取所有股票价格
- 自动重试机制
- 避免 429 错误

---

## [v1.4] - 2025-12-28

### 价格预警功能改进

#### 优化添加预警表单

**改进**：
- 预设股数和备注字段始终显示
- 选择"无"时字段自动禁用（变灰）
- 提供清晰的提示文字

**效果**：用户可以提前看到所有选项，更直观

#### 添加编辑激活预警功能

**新增功能**：
- ✏️ 编辑按钮：编辑任何激活的预警
- 🗑️ 删除按钮：删除不需要的预警

**可编辑字段**：
- 预警类型、目标价格
- 通知方式、邮箱地址
- 预设操作、预设股数、操作备注

**编辑界面**：
- 展开式编辑表单
- 所有字段预填充当前值
- 保存/取消按钮

---

## [v1.3] - 2025-12-27

### 价格获取功能优化

#### 问题：429 Too Many Requests

**原因**：Yahoo Finance API 请求过于频繁

**解决方案**：

1. **批量下载模式**（推荐）
   - 一次 API 请求获取多个股票价格
   - 自动启用

2. **自动重试机制**
   - 最多 3 次重试
   - 递增延迟（1秒、2秒、3秒）
   - 批量失败时自动切换到单独获取

3. **请求延迟**
   - 单独获取模式下，每个请求间延迟 1-2 秒
   - 避免触发速率限制

#### 修复 yfinance 警告

**问题**：
```
yfinance: download(show_errors=False) argument is deprecated
```

**解决方案**：
- 移除 `show_errors=False` 参数
- 使用 logging 配置抑制警告

---

## [v1.2] - 2025-12 初版

### 核心功能实现

#### 交易管理
- 股票交易录入
- 期权交易录入
- 交易历史查看

#### 账户总览
- 总资金、已投资、可用现金
- 期权锁定、权利金收入
- 资产配置饼图
- 持仓分布柱状图

#### 仓位管理
- 股票持仓详情
- 期权持仓详情
- 目标设置

#### 决策支持
- 期权策略评估
- 价格预警
- 仓位管理

#### 分析工具
- 业绩归因分析
- 相关性分析
- 现金流分析

#### 反思学习
- 交易日志
- 定期总结

#### 可视化
- Plotly 交互式图表
- 多页面 Dashboard

---

## 未来计划

### 短期计划（1-3个月）

- [ ] 数据备份增强（删除前自动备份、版本控制）
- [ ] 审计日志（记录所有修改操作）
- [ ] 批量操作（批量编辑、删除、导入/导出）
- [ ] 盈亏颜色标识（绿/红）
- [ ] 价格更新时间戳显示

### 中期计划（3-6个月）

- [ ] 自动化交易执行（券商 API 集成）
- [ ] 智能再平衡策略（动态阈值、税务优化）
- [ ] 可视化增强（偏离趋势图、再平衡历史）
- [ ] 移动端适配
- [ ] 主题定制（深色/浅色模式）

### 长期计划（6-12个月）

- [ ] 机器学习优化（最优再平衡时机预测）
- [ ] 多账户协调再平衡
- [ ] 风险指标集成（组合风险评分）
- [ ] 社区功能（策略分享）
- [ ] API 接口（第三方集成）

---

## 版本说明

- **v2.x**：完整 CRUD 支持，Dashboard 改进，期权历史完整记录
- **v1.x**：核心功能实现，UI 优化，价格获取改进

---

**维护者**：Portfolio Manager Team
**最后更新**：2026-01-02
