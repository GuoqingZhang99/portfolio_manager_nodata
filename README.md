# 投资组合管理系统

Portfolio Management System - 一个功能完整的个人投资组合管理工具。

## 功能特点

- **交易管理** - 股票/期权交易记录与交易日志，支持完整的增删改查（CRUD）操作
- **自动计算** - 持仓汇总、账户总览、现金流分析、盈亏计算
- **决策支持** - 期权策略评估、价格预警、仓位管理
- **高级分析** - 业绩归因、相关性分析
- **反思学习** - 交易日志、定期总结、模式识别
- **可视化** - Dashboard、多类型图表、交互式分析
- **安全操作** - 删除操作带确认对话框，防止误操作
- **完整历史** - 记录所有交易和期权的完整生命周期

## 安装步骤

### 1. 创建虚拟环境（推荐）

```bash
cd portfolio_manager
python -m venv venv

# Windows
venv\Scripts\activate

# Mac/Linux
source venv/bin/activate
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 运行系统

```bash
python run.py
```

或者直接使用 Streamlit：

```bash
streamlit run ui/dashboard.py
```

系统将在浏览器中自动打开，默认地址：http://localhost:8501

## 首次使用

1. **系统自动初始化**
   - 首次运行自动创建 `data/portfolio.db`
   - 创建所有表结构
   - 插入默认账户数据（长期账户、波段账户）

2. **配置账户**
   - 进入"数据管理"页面
   - 修改账户总资金、现金储备等

3. **开始使用**
   - 录入第一笔交易
   - 填写交易日志
   - 查看账户总览

## 核心功能详解

### 交易管理（CRUD完整支持）

系统支持对股票交易和期权交易进行完整的增删改查操作：

#### 股票交易
- **新增交易**：在"录入交易"页面输入交易信息
- **编辑交易**：点击历史交易列表中的"编辑"按钮，修改后点击"更新交易"
- **删除交易**：点击"删除"按钮，系统会弹出确认对话框，防止误操作
- **查看历史**：自动记录所有交易历史，支持按各列排序

#### 期权交易
- **新增期权**：在"录入期权"页面输入期权信息
- **编辑期权**：点击历史期权列表中的"编辑"按钮，修改后点击"更新期权"
- **删除期权**：点击"删除"按钮，系统会弹出确认对话框
- **完整生命周期**：记录期权从开仓到平仓/到期/行权的完整过程
- **盈亏计算**：自动计算每笔期权的盈亏（权利金收入 - 平仓成本 - 手续费）

### 账户总览Dashboard

#### 关键指标
- **总资金**：账户总资本
- **已投资**：投入股票的金额和仓位占比
- **可用现金**：未投资的可用资金
- **账户总盈亏**：当前总资产 - 初始资本 - 净现金流入
  - 净现金流入包括：利息、存款、取款
  - 不包括交易产生的现金流
- **总盈亏比%**：总盈亏 / (初始资本 + 净现金流入) × 100%
- **期权锁定**：被期权合约锁定的现金
- **期权权利金收入**：卖出期权获得的总权利金

#### 可视化图表
- **资产配置饼图**：展示各股票、期权锁定、可用现金的占比
- **持仓分布柱状图**：展示各股票的投资金额
- **持仓明细表**：显示每只股票的成本、现价、盈亏等信息

#### 数据排序
- 点击表格列标题可进行升序/降序排序
- 系统使用数值排序，确保排序结果准确

### 仓位管理

#### 股票持仓详情
- 显示每只股票的持仓数量、成本、市值、盈亏
- 区分可用股数和被期权锁定的股数
- 支持按各指标排序查看

#### 期权持仓详情
系统完整记录期权的生命周期，分为两个区域：

##### 📊 持仓中期权
- 显示所有未平仓的期权合约
- 包含：股票代码、期权类型、行权价、到期日、合约数、权利金、剩余天数
- 按开仓日期降序排列

##### 📜 已平仓/到期期权历史
- 显示所有已结束的期权（平仓、到期、行权）
- 自动计算每笔期权的盈亏
- 记录开仓和平仓的完整信息
- 按结束日期降序排列

### 价格刷新

- **自动刷新**：系统根据市场开盘时间自动刷新价格
- **手动刷新**：点击Dashboard右上角的"🔄 刷新价格"按钮
- **市场状态**：实时显示市场开盘/闭盘状态
- **更新时间**：显示最后价格更新的时间戳

### 安全特性

#### 确认对话框
- 所有删除操作都会弹出确认对话框
- 对话框显示要删除的记录详情
- 明确标注"此操作无法撤销"警告
- 需要用户明确点击"确认删除"才会执行

#### 数据完整性
- 所有修改操作都会立即保存到数据库
- 支持数据库备份功能
- 自动记录所有历史数据

## 目录结构

```
portfolio_manager/
├── config.py                 # 全局配置
├── run.py                    # 启动脚本
├── requirements.txt          # 依赖包
├── data/                     # 数据目录
│   ├── portfolio.db          # SQLite数据库
│   ├── manual_prices.json    # 手动价格数据
│   ├── price_timestamps.json # 价格时间戳
│   └── backups/              # 备份目录
├── scripts/                  # 脚本工具
│   ├── migrations/           # 数据库迁移脚本
│   │   └── add_shares_columns.py
│   └── tools/                # 工具脚本
│       ├── check_realtime_price.py
│       ├── get_real_prices.py
│       └── run_price_settings.py
├── tests/                    # 测试文件
│   ├── test_price_fetch.py
│   └── test_realtime_prices.py
├── docs/                     # 项目文档
│   ├── ALERT_MONITORING_GUIDE.md # 价格预警自动监控指南
│   ├── EMAIL_SETUP_GUIDE.md      # 邮件通知配置指南
│   ├── PRICE_SOURCES_GUIDE.md    # 价格数据源配置指南
│   ├── REBALANCING_GUIDE.md      # 投资组合再平衡完全指南
│   └── CHANGELOG.md              # 版本更新历史
├── core/                     # 核心业务逻辑
│   ├── database.py           # 数据库操作
│   ├── calculator.py         # 投资组合计算
│   ├── cash_flow.py          # 现金流管理
│   ├── attribution.py        # 业绩归因
│   └── correlation.py        # 相关性分析
├── decision/                 # 决策支持模块
│   ├── option_strategy.py    # 期权策略
│   ├── alert_system.py       # 价格预警
│   └── position_manager.py   # 仓位管理
├── reflection/               # 反思学习模块
│   ├── journal.py            # 交易日志
│   ├── summary.py            # 总结生成器
│   └── reminder.py           # 提醒系统
├── visualization/            # 可视化模块
│   ├── charts.py             # 图表组件
│   └── reports.py            # 报告生成器
├── ui/                       # 用户界面
│   ├── dashboard.py          # 主界面
│   ├── components/           # UI组件
│   └── pages/                # 各功能页面
│       ├── dashboard_overview.py
│       ├── position_management.py
│       └── ...
└── utils/                    # 工具函数
    ├── data_fetcher.py       # 股价获取
    ├── price_sources.py      # 价格源管理
    ├── market_hours.py       # 市场时间
    ├── helpers.py            # 辅助函数
    └── constants.py          # 常量定义
```

## 高级功能

### 决策支持

#### 期权策略评估
- 预设策略规则（保守型/激进型 Covered Call 和 Cash Secured Put）
- 评估 Delta、Theta、IV 百分位
- 提供策略推荐和评分

#### 价格预警
- 支持三种预警类型（高于/低于/穿越）
- 桌面通知和邮件通知
- 预设操作和备注
- 自动监控和触发

#### 仓位管理与再平衡
- 支持三种目标类型（百分比/金额/股数）
- 自动计算偏离和生成再平衡建议
- 优先级管理
- 资金需求分析

### 分析工具

#### 业绩归因分析
- 计算 Beta 和 Alpha 值（对比基准如 SPY）
- 分解投资回报为技能和运气成分
- 风险调整后收益评估

#### 相关性分析
- 计算持仓股票间的相关性矩阵（90天回溯）
- 识别高相关性风险（阈值 0.7）
- 优化资产多样化

### 反思与学习

#### 交易日志
- 记录决策背景和理由
- 追踪信心水平和情绪状态
- 风险参数记录
- 关联具体交易

#### 定期总结
- 自动生成股票、账户、周期总结
- 模板化反思流程
- 追踪成功、失败和教训

## 日常工作流

### 每天
1. 打开系统查看账户总览和总盈亏
2. 点击"刷新价格"获取最新市场价格
3. 检查价格预警和期权剩余天数
4. 如有交易，录入交易记录
5. 填写交易日志
6. 如发现录入错误，可使用编辑功能修改

### 每周
1. 复盘本周交易
2. 查看期权持仓状态
3. 检查已平仓期权的盈亏情况
4. 更新日志

### 每月
1. 完成月度总结
2. 查看业绩归因和总盈亏比
3. 检查仓位偏离
4. 调整目标（如需要）
5. 备份数据库

## 数据源说明

系统使用 **yahooquery** 获取股票价格：

### 优势特性

✅ **批量优化**：多个股票一次API调用
- 传统方式：9个股票 = 9次API调用
- 批量模式：9个股票 = 1次API调用
- 节省：89% API调用量

✅ **盘后缓存**：智能使用收盘价缓存
- 盘后自动使用今日收盘价
- 减少96% API调用

✅ **性能提升**：响应速度比yfinance快45-60倍

### 数据延迟说明

⚠️ **重要限制**：Yahoo Finance免费API提供15-20分钟延迟数据

**适用场景**：
- ✅ 日常监控
- ✅ 价格预警
- ✅ 趋势分析

**不适用场景**：
- ❌ 高频交易
- ❌ 秒级精度需求

详细说明：[docs/PRICE_SOURCES_GUIDE.md](docs/PRICE_SOURCES_GUIDE.md)

## 配置指南

### 邮件通知配置
详见：[docs/EMAIL_SETUP_GUIDE.md](docs/EMAIL_SETUP_GUIDE.md)
- Gmail / Outlook 配置
- SMTP 设置
- 默认通知方式

### 价格预警自动监控
详见：[docs/ALERT_MONITORING_GUIDE.md](docs/ALERT_MONITORING_GUIDE.md)
- 自动启动监控
- 后台持续运行
- 定期检查预警
- 实时通知提醒

### 价格数据源配置
详见：[docs/PRICE_SOURCES_GUIDE.md](docs/PRICE_SOURCES_GUIDE.md)
- 手动输入价格
- Alpha Vantage API
- Finnhub API
- 多数据源优先级

### 投资组合再平衡
详见：[docs/REBALANCING_GUIDE.md](docs/REBALANCING_GUIDE.md)
- 再平衡概念和策略
- 目标设置方法
- 实际案例和最佳实践

## 技术栈

- **前端**: Streamlit
- **后端**: Python 3.10+
- **数据库**: SQLite
- **图表**: Plotly
- **数据获取**: yahooquery (批量优化，15-20分钟延迟)

## 数据备份

系统在"数据管理"页面提供备份功能：
- 手动备份：点击"立即备份"
- 备份位置：`data/backups/`

## 更新日志

查看完整的版本更新历史：[docs/CHANGELOG.md](docs/CHANGELOG.md)

## 注意事项

- 股价数据通过 yahooquery 获取，需要网络连接
- ⚠️ **数据延迟**: Yahoo Finance免费API提供15-20分钟延迟数据，适合日常监控，不适合高频交易
- 首次运行会自动创建数据库和默认账户
- 建议定期备份数据库

## 许可证

MIT License
